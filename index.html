<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLä¸‡åœ£èŠ‚è¶£å‘³å•</title>
    <!-- Tail    éƒ¨ç½²éƒ¨ç½²è¯´æ˜ï¼š
    1. å°†æ­¤æ–‡ä»¶ä¿å­˜ä¸ºindex.htmlå¹¶ä¸Šä¼ åˆ°GitHubä»“åº“
    2. å¯ç”¨GitHub Pagesåï¼Œç©å®¶é€šè¿‡ä¸»é“¾æ¥è¿›å…¥æ¸¸æˆ
    3. è§‚ä¼—å¯é€šè¿‡åˆ†äº«é“¾æ¥åœ¨å…¶ä»–è®¾å¤‡è§‚çœ‹å®æ—¶æ¸¸æˆ
    -->
    <!-- Tail    åŠŸèƒ½ç‰¹ç‚¹ï¼š
    - ç©å®¶æ¨¡å¼ï¼šæ“ä½œæ¸¸æˆï¼Œå®æ—¶åŒæ­¥çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
    - è§‚ä¼—æ¨¡å¼ï¼šé€šè¿‡åˆ†äº«é“¾æ¥è§‚çœ‹ï¼Œè‡ªåŠ¨åŒæ­¥ç©å®¶æ“ä½œ
    - è·¨è®¾å¤‡åŒæ­¥ï¼šåŸºäºlocalStorage+æ¸¸æˆIDå®ç°çŠ¶æ€å…±äº«
    - æ–­çº¿é‡è¿ï¼šè§‚ä¼—ç«¯è‡ªåŠ¨è‡ªåŠ¨æ£€æµ‹è‡ªåŠ¨æ¸¸æˆçŠ¶æ€å˜åŒ–
    -->
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6',
                        secondary: '#EC4899',
                        accent: '#FBBF24',
                        danger: '#EF4444',
                        light: '#F3F4F6',
                        dark: '#1F2937',
                        spectator: '#3B82F6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'celebrate': 'celebrate 0.5s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        celebrate: {
                            '0%': { transform: 'scale(1)' },
                            '100%': { transform: 'scale(1.2)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }
            .square-active {
                border: 2px solid #FBBF24;
                box-shadow: 0 0 15px rgba(251, 191, 36, 0.8);
            }
            .gradient-card {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }
            .mode-active {
                border-color: #FBBF24;
                background-color: rgba(251, 191, 36, 0.2);
                box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
            }
            .spectator-badge {
                background-color: rgba(59, 130, 246, 0.2);
                border: 1px solid rgba(59, 130, 246, 0.4);
            }
        }
    </style>
    
    <style>
        body {
            background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            backdrop-filter: blur(10px);
        }
        
        .square {
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
            border-radius: 0.75rem;
            position: relative;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
        
        .square:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .square.current {
            background-color: #FBBF24;
            color: #1F2937;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.7);
            z-index: 5;
        }
        
        .player {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            z-index: 10;
            transition: all 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
            top: 24px;
            right: 24px;
        }
        
        .player-1 {
            background-color: #EF4444;
        }
        
        .item-marker {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background-color: #FBBF24;
            color: #1F2937;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 8;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .item-marker:hover + .item-tooltip {
            display: block;
        }
        
        .item-tooltip {
            position: absolute;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1F2937;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 15;
            display: none;
        }
        
        #move-button, #start-game, #next-to-items, #next-to-game {
            background: linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%);
        }
        
        #move-button:hover, #start-game:hover, #next-to-items:hover, #next-to-game:hover {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        }
        
        .item-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .item-active {
            border: 2px solid #FBBF24;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.7);
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall 3s linear forwards;
            z-index: 100;
        }
        
        @keyframes fall {
            to {
                transform: translateY(100vh);
                opacity: 0;
            }
        }
        
        /* ä»‹ç»å¡ç‰‡æ ·å¼ */
        .intro-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .intro-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        /* æ¨¡å¼é€‰æ‹©æŒ‰é’®æ ·å¼ */
        .mode-btn {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        /* é˜¶æ®µå®¹å™¨æ ·å¼ */
        .stage-container {
            display: none;
        }
        
        .stage-container.active {
            display: block;
        }
        
        /* è§‚ä¼—æ¨¡å¼æ ·å¼ */
        .spectator-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px 15px;
            border-radius: 20px;
            color: #3B82F6;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .spectator-mode .interactive-element {
            pointer-events: none;
            opacity: 0.6;
        }
        
        .share-link-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .share-link {
            flex-grow: 1;
            padding: 5px 10px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            font-size: 0.875rem;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            z-index: 999;
        }
        
        .sync-status.connected {
            background-color: rgba(0, 255, 0, 0.5);
        }
        
        .sync-status.disconnected {
            background-color: rgba(255, 0, 0, 0.5);
        }
    </style>
</head>
<body class="min-h-screen font-sans text-dark">
    <!-- åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="sync-status" class="sync-status">
        <i class="fa fa-circle-o-notch fa-spin mr-1"></i> ç­‰å¾…åŒæ­¥...
    </div>

    <div class="container mx-auto px-4 py-6">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white flex items-center">
                <i class="fa fa-pumpkin-o mr-3 text-accent"></i>HLä¸‡åœ£èŠ‚è¶£å‘³å•
            </h1>
            <!-- æ¸¸æˆè§’è‰²é€‰æ‹© -->
            <div class="flex gap-3">
                <button id="play-as-player" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg flex items-center backdrop-blur-sm interactive-element">
                    <i class="fa fa-user mr-2"></i> ç©å®¶
                </button>
                <button id="play-as-spectator" class="bg-spectator/20 hover:bg-spectator/30 text-spectator px-4 py-2 rounded-lg flex items-center backdrop-blur-sm interactive-element">
                    <i class="fa fa-eye mr-2"></i> è§‚ä¼—
                </button>
            </div>
        </div>
        
        <!-- åˆ†äº«é“¾æ¥åŒºåŸŸ -->
        <div id="share-section" class="max-w-md mx-auto mb-6 bg-white/20 rounded-xl p-4 backdrop-blur-md hidden">
            <div class="flex justify-between items-center mb-2">
                <span class="font-bold text-white">åˆ†äº«æ¸¸æˆ</span>
                <span class="text-xs text-white/70">ä»–äººå¯é€šè¿‡é“¾æ¥è§‚çœ‹æ¸¸æˆ</span>
            </div>
            <div class="share-link-container">
                <input type="text" id="game-share-link" class="share-link" readonly>
                <button id="copy-share-link" class="bg-white/30 hover:bg-white/40 text-white p-2 rounded-lg interactive-element">
                    <i class="fa fa-copy"></i>
                </button>
            </div>
        </div>
        
        <!-- æ“ä½œæç¤º -->
        <p class="text-center text-white/90 mb-6 text-lg" id="stage-instruction">é€‰æ‹©æ¸¸æˆéš¾åº¦ï¼Œå¼€å§‹ä½ çš„ä¸‡åœ£èŠ‚è¶£å‘³ä¹‹æ—…ï¼</p>
        
        <!-- ç¬¬ä¸€é˜¶æ®µï¼šæ¨¡å¼é€‰æ‹©ä¸æ¸¸æˆä»‹ç» -->
        <div id="mode-selection-stage" class="stage-container active">
            <!-- æ¸¸æˆä»‹ç»åŒºåŸŸ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- è¶£å‘³ç©æ³• -->
                <div class="intro-card gradient-card rounded-xl p-6 text-white">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mr-3">
                            <i class="fa fa-gamepad text-2xl text-accent"></i>
                        </div>
                        <h3 class="text-xl font-bold">è¶£å‘³ç©æ³•</h3>
                    </div>
                    <ul class="space-y-2 text-white/90">
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-accent mt-1 mr-2"></i>
                            <span>å‰è¿›æ¡ä»¶:åŒæ‰“æ‰‹æ€»è®¡äººå¤´æ•°1ä¸ªå¯ä»¥å‰è¿›ä¸€æ ¼</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-accent mt-1 mr-2"></i>
                            <span>åé€€æ¡ä»¶:æ‘¸åˆ°1-2æ ¼çº¢åŒ…,æ‘¸åˆ°4æ ¼çº¢åŒ…é€€2æ­¥,æ‘¸åˆ°6æ ¼çº¢åŒ…é€€3æ­¥</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-accent mt-1 mr-2"></i>
                            <span>æ’¤é€€å¤±è´¥çš„çº¢åŒ…è®¡å…¥æ‰“æ‰‹äººå¤´ä¸è®¡å…¥åé€€æ­¥æ•°</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-accent mt-1 mr-2"></i>
                            <span>æ‘¸åˆ°ç‰¹æ®Šæ ¼å­åé€€6æ­¥</span>
                        </li>
                    </ul>
                </div>
                
                <!-- é“å…·ç³»ç»Ÿ -->
                <div class="intro-card gradient-card rounded-xl p-6 text-white">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mr-3">
                            <i class="fa fa-gift text-2xl text-accent"></i>
                        </div>
                        <h3 class="text-xl font-bold">é“å…·ç³»ç»Ÿ</h3>
                    </div>
                    <ul class="space-y-2 text-white/90">
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-accent mt-1 mr-2"></i>
                            <span>æ€»å…±æœ‰9å¼ é“å…·å¡å¯è‡ªé€‰</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-accent mt-1 mr-2"></i>
                            <span>æ™®é€šç‰ˆå¯ä»¥é€‰3å¼ é“å…·å¡</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-accent mt-1 mr-2"></i>
                            <span>å›°éš¾ç‰ˆå¯ä»¥é€‰6å¼ é“å…·å¡</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-accent mt-1 mr-2"></i>
                            <span>è§¦å‘é“å…·åè·å¾—ç‰¹æ®Šæ•ˆæœ</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- æ¨¡å¼é€‰æ‹©åŒºåŸŸ -->
            <div class="max-w-md mx-auto mb-8 bg-white/20 rounded-xl p-6 backdrop-blur-md">
                <h3 class="text-xl font-bold text-white mb-6 text-center">é€‰æ‹©æ¸¸æˆæ¨¡å¼</h3>
                <div class="grid grid-cols-2 gap-6">
                    <div class="mode-btn mode-active border-2 rounded-lg p-6 text-center text-white interactive-element">
                        <h4 class="font-bold text-accent mb-3">æ™®é€šç‰ˆ</h4>
                        <p class="text-sm">å¯é€‰æ‹©3å¼ é“å…·å¡</p>
                        <div class="mt-4 text-sm text-white/80">é€‚åˆæ–°æ‰‹ä½“éªŒ</div>
                    </div>
                    <div class="mode-btn border-2 border-transparent rounded-lg p-6 text-center text-white interactive-element">
                        <h4 class="font-bold text-white mb-3">å›°éš¾ç‰ˆ</h4>
                        <p class="text-sm">å¯é€‰æ‹©6å¼ é“å…·å¡</p>
                        <div class="mt-4 text-sm text-white/80">æŒ‘æˆ˜æ›´å¤šä¹è¶£</div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸‹ä¸€æ­¥æŒ‰é’® -->
            <div class="flex justify-center">
                <button id="next-to-items" class="text-dark text-xl font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 interactive-element">
                    è¿›å…¥é“å…·é…ç½® <i class="fa fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
        
        <!-- ç¬¬äºŒé˜¶æ®µï¼šé“å…·æ”¾ç½® -->
        <div id="item-placement-stage" class="stage-container">
            <!-- é“å…·æ”¾ç½®åŒº -->
            <div class="bg-white/20 rounded-xl p-4 mb-6 max-w-md mx-auto backdrop-blur-md">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-white">é“å…·æ“ä½œ</span>
                    <button id="clear-all-items-prep" class="text-white hover:text-accent text-sm interactive-element">
                        <i class="fa fa-trash mr-1"></i> æ¸…é™¤æ‰€æœ‰é“å…·
                    </button>
                </div>
                <div id="placed-items-count-prep" class="text-white py-2 px-3 bg-white/10 rounded-lg min-h-[40px]">
                    å·²æ”¾ç½®é“å…·ï¼š0/3ï¼ˆæ™®é€šç‰ˆæœ€å¤šæ”¾ç½®3ä¸ªï¼‰
                </div>
            </div>
            
            <!-- é“å…·åˆ—è¡¨ä¸é€‰æ‹©åŒº -->
            <div class="bg-white/20 rounded-xl p-4 mb-6 max-w-md mx-auto backdrop-blur-md">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-white">é€‰æ‹©é“å…·ï¼ˆç‚¹å‡»æ”¾ç½®ï¼‰</span>
                    <button id="show-items-prep" class="text-white hover:text-accent text-sm interactive-element">
                        <i class="fa fa-info-circle mr-1"></i> é“å…·è¯´æ˜
                    </button>
                </div>
                <div class="grid grid-cols-3 gap-2 mt-3" id="item-selection-grid-prep">
                    <!-- é“å…·é€‰æ‹©å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- æ£‹ç›˜åŒºåŸŸï¼ˆé“å…·æ”¾ç½®é˜¶æ®µï¼‰ -->
            <div class="game-board mb-8" id="game-board-prep">
                <!-- æ£‹ç›˜æ ¼å­å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- æŒ‰é’®åŒºåŸŸ -->
            <div class="flex justify-center space-x-4">
                <button id="back-to-mode" class="bg-white/30 hover:bg-white/40 text-white px-6 py-3 rounded-full shadow-lg transition-all duration-300 interactive-element">
                    <i class="fa fa-arrow-left mr-2"></i> è¿”å›æ¨¡å¼é€‰æ‹©
                </button>
                <button id="next-to-game" class="text-dark text-xl font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 interactive-element">
                    å¼€å§‹æ¸¸æˆ <i class="fa fa-play ml-2"></i>
                </button>
            </div>
        </div>
        
        <!-- ç¬¬ä¸‰é˜¶æ®µï¼šæ¸¸æˆé˜¶æ®µ -->
        <div id="game-stage" class="stage-container">
            <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
            <div class="max-w-2xl mx-auto mb-6 bg-white/20 rounded-xl p-4 backdrop-blur-md">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-white font-medium">å½“å‰è¿›åº¦</span>
                    <span id="progress-text" class="text-white font-bold text-lg">1/20</span>
                </div>
                <div class="w-full bg-white/30 rounded-full h-3">
                    <div id="progress-bar" class="bg-accent h-3 rounded-full transition-all duration-500 ease-out" style="width: 5%"></div>
                </div>
            </div>
            
            <!-- æ¸¸æˆæ ‡é¢˜ä¸æ“ä½œæç¤º -->
            <header class="text-center mb-6">
                <h1 class="text-4xl font-bold text-white mb-2 text-shadow">äºŒåæ ¼å‰è¿›æ¸¸æˆ</h1>
                <p class="text-lg text-white/90 mb-2">ç‚¹å‡»å‰è¿›æŒ‰é’®ç§»åŠ¨ï¼Œè§¦å‘æ ¼å­é“å…·æ•ˆæœ</p>
            </header>
            
            <!-- æ¸¸æˆçŠ¶æ€ -->
            <div class="bg-white/20 rounded-xl p-4 mb-6 max-w-md mx-auto backdrop-blur-md">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="font-bold text-white">å½“å‰ä½ç½®ï¼š</span>
                        <span id="current-position" class="ml-2 font-semibold text-white">ç¬¬ 1 æ ¼</span>
                    </div>
                    <div id="game-status" class="text-sm font-medium text-white">æ¸¸æˆè¿›è¡Œä¸­</div>
                </div>
            </div>
            
            <!-- å‰è¿›æŒ‰é’®åŒºåŸŸ -->
            <div class="flex flex-col items-center justify-center mb-6">
                <button id="move-button" class="text-dark text-2xl font-bold py-4 px-10 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 interactive-element">
                    <i class="fa fa-arrow-right mr-2"></i> å‰è¿›ä¸€æ ¼
                </button>
                <div id="move-value" class="text-center mt-4 text-xl font-bold text-white">ç‚¹å‡»æŒ‰é’®å‰è¿›</div>
            </div>
            
            <!-- æ£‹ç›˜åŒºåŸŸï¼ˆæ¸¸æˆé˜¶æ®µï¼‰ -->
            <div class="game-board mb-8" id="game-board">
                <!-- æ£‹ç›˜æ ¼å­å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- æ¸¸æˆæ§åˆ¶åŒº -->
            <div class="bg-white/20 rounded-lg p-6 max-w-md mx-auto backdrop-blur-md">
                <h2 class="text-xl font-bold mb-4 text-center text-white">æ¸¸æˆæ§åˆ¶</h2>
                
                <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
                <div class="flex space-x-4 justify-center">
                    <button id="reset-game" class="bg-white/30 hover:bg-white/40 text-white px-6 py-3 rounded-lg flex items-center backdrop-blur-sm interactive-element">
                        <i class="fa fa-refresh mr-2"></i> é‡æ–°å¼€å§‹
                    </button>
                    <button id="back-to-items" class="bg-white/30 hover:bg-white/40 text-white px-6 py-3 rounded-lg flex items-center backdrop-blur-sm interactive-element">
                        <i class="fa fa-arrow-left mr-2"></i> ä¿®æ”¹é“å…·
                    </button>
                </div>
            </div>
        </div>
        
        <!-- é“å…·è¯´æ˜æ¨¡æ€æ¡† -->
        <div id="items-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">é“å…·åˆ—è¡¨</h3>
                    <button id="close-items" class="text-gray-500 hover:text-gray-700 interactive-element">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="item-modal-content space-y-4 max-h-72 overflow-y-auto">
                    <div class="item-card p-3 bg-red-50 rounded-lg">
                        <h4 class="font-bold text-red-600">ä¸ç»™ç³–å°±æ£è›‹</h4>
                        <p class="text-sm text-gray-600">å¼€å±€è€æ¿æŒ‡å®šä¸€ä¸ªä»»æ„çº¢ï¼Œè‹¥å‡ºäº†è€æ¿å¦å¤šé€‰ä»»é€‰ä¸€å¼ é“å…·å¡ç»™é™ªç©ä½¿ç”¨ï¼Œåªèƒ½è§¦å‘ä¸€æ¬¡ï¼Œè§¦å‘è¿‡åæ­¤é“å…·å¡å¤±æ•ˆ</p>
                    </div>
                    
                    <div class="item-card p-3 bg-purple-50 rounded-lg">
                        <h4 class="font-bold text-purple-600">æˆ‘ä¸æ˜¯æ­Œç¥</h4>
                        <p class="text-sm text-gray-600">åŒæ‰“æ‰‹éœ€è¦å”±ä¸€æ®µ7-15sçš„æ­Œ</p>
                    </div>
                    
                    <div class="item-card p-3 bg-gray-50 rounded-lg">
                        <h4 class="font-bold text-gray-600">æˆ‘æ˜¯å‹åŠ›æ€ª</h4>
                        <p class="text-sm text-gray-600">å½“å±€ä¸€åæ‰“æ‰‹å¿…é¡»ä¸€ç›´å‹åŠ›å¦ä¸€ä½æ‰“æ‰‹</p>
                    </div>
                    
                    <div class="item-card p-3 bg-yellow-50 rounded-lg">
                        <h4 class="font-bold text-yellow-600">coså°çŒ«</h4>
                        <p class="text-sm text-gray-600">å½“å±€æ‰“æ‰‹å¿…é¡»è¯´å®Œè¯åè¾¹åŠ ä¸Š"å–µ"</p>
                    </div>
                    
                    <div class="item-card p-3 bg-green-50 rounded-lg">
                        <h4 class="font-bold text-green-600">åƒæˆ‘ä¸€æŠ€</h4>
                        <p class="text-sm text-gray-600">è¯¥å±€æ‰“æ‰‹é‡Šæ”¾è‹±é›„æŠ€èƒ½å¿…é¡»å–Šå‡ºæ¥æŠ€èƒ½åå­—</p>
                    </div>
                    
                    <div class="item-card p-3 bg-pink-50 rounded-lg">
                        <h4 class="font-bold text-pink-600">ç”œèœœèœœ</h4>
                        <p class="text-sm text-gray-600">åŒæ‰“æ‰‹å½“å±€éœ€è¦äº’ç›¸ç”œèœœè¿›è¡Œæ¸¸æˆ</p>
                    </div>
                    
                    <div class="item-card p-3 bg-blue-50 rounded-lg">
                        <h4 class="font-bold text-blue-600">coså°é¬¼</h4>
                        <p class="text-sm text-gray-600">åŒæ‰“æ‰‹å„è‡ªæ‰®æ¼”å°é¬¼ï¼Œä¾‹å¦‚å¯çˆ±é¬¼ã€èƒ†å°é¬¼è¿™ç§ï¼Œæ¸¸æˆå¯¹å±€ä¸­ï¼Œäº’ç›¸ç§°å‘¼å˜æˆæ‰®æ¼”çš„å°é¬¼åç§°</p>
                    </div>
                    
                    <div class="item-card p-3 bg-orange-50 rounded-lg">
                        <h4 class="font-bold text-orange-600">æˆ‘ä¼šè¯´æ–¹è¨€</h4>
                        <p class="text-sm text-gray-600">åŒæ‰“æ‰‹å½“å±€æ¸¸æˆå¿…é¡»ç”¨æ–¹è¨€æ²Ÿé€š</p>
                    </div>
                    
                    <div class="item-card p-3 bg-teal-50 rounded-lg">
                        <h4 class="font-bold text-teal-600">ç»æ´»å°é¬¼</h4>
                        <p class="text-sm text-gray-600">è€æ¿æŒ‡å®šä¸€æ®µè¯10-15å­—ï¼ŒåŒæ‰“æ‰‹å¿…é¡»å«æ°´è¯»å‡ºæ¥</p>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <button id="close-items-btn" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/80 interactive-element">å…³é—­</button>
                </div>
            </div>
        </div>
        
        <!-- èƒœåˆ©æ¨¡æ€æ¡† -->
        <div id="winner-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md mx-auto text-center">
                <div class="winner-animation mb-4">
                    <i class="fa fa-trophy text-6xl text-yellow-500"></i>
                </div>
                <h3 class="text-2xl font-bold mb-2">æ­å–œï¼</h3>
                <p id="winner-text" class="text-xl mb-6">æ­å–œä½ è·èƒœï¼</p>
                <div class="flex space-x-4 justify-center">
                    <button id="play-again" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/80 interactive-element">å†ç©ä¸€æ¬¡</button>
                    <button id="close-winner" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 interactive-element">å…³é—­</button>
                </div>
            </div>
        </div>
        
        <!-- é“å…·è§¦å‘æç¤ºæ¡† -->
        <div id="item-trigger-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md mx-4 text-center">
                <div class="mb-4 text-4xl">
                    <i class="fa fa-magic text-purple-500 winner-animation"></i>
                </div>
                <h3 class="text-2xl font-bold mb-2">è§¦å‘é“å…·æ•ˆæœï¼</h3>
                <p id="item-trigger-name" class="text-xl font-medium mb-4"></p>
                <p id="item-trigger-desc" class="text-gray-600 mb-6">è·å¾—é¢å¤–å‰è¿›1æ¬¡çš„æœºä¼šï¼</p>
                <button id="continue-button" class="bg-accent text-dark px-6 py-3 rounded-lg hover:bg-accent/80 interactive-element">ç»§ç»­å‰è¿›</button>
            </div>
        </div>
        
        <!-- è§‚ä¼—æ¨¡å¼æ ‡è¯† -->
        <div id="spectator-badge" class="spectator-overlay spectator-badge hidden">
            <i class="fa fa-eye mr-2"></i> è§‚ä¼—æ¨¡å¼
        </div>
    </div>

    <script>
        // æ¸¸æˆé…ç½®
        const GAME_CONFIG = {
            totalSquares: 20,
            modes: {
                normal: {
                    name: "æ™®é€šç‰ˆ",
                    maxItems: 3
                },
                hard: {
                    name: "å›°éš¾ç‰ˆ",
                    maxItems: 6
                }
            },
            // é“å…·åˆ—è¡¨
            items: [
                {
                    id: 1,
                    name: "ä¸ç»™ç³–å°±æ£è›‹",
                    icon: "ğŸ¬",
                    description: "å¼€å±€è€æ¿æŒ‡å®šä¸€ä¸ªä»»æ„çº¢ï¼Œè‹¥å‡ºäº†è€æ¿å¦å¤šé€‰ä»»é€‰ä¸€å¼ é“å…·å¡ç»™é™ªç©ä½¿ç”¨ï¼Œåªèƒ½è§¦å‘ä¸€æ¬¡ï¼Œè§¦å‘è¿‡åæ­¤é“å…·å¡å¤±æ•ˆ"
                },
                {
                    id: 2,
                    name: "æˆ‘ä¸æ˜¯æ­Œç¥",
                    icon: "ğŸ¤",
                    description: "åŒæ‰“æ‰‹éœ€è¦å”±ä¸€æ®µ7-15sçš„æ­Œ"
                },
                {
                    id: 3,
                    name: "æˆ‘æ˜¯å‹åŠ›æ€ª",
                    icon: "ğŸ’¥",
                    description: "å½“å±€ä¸€åæ‰“æ‰‹å¿…é¡»ä¸€ç›´å‹åŠ›å¦ä¸€ä½æ‰“æ‰‹"
                },
                {
                    id: 4,
                    name: "coså°çŒ«",
                    icon: "ğŸ±",
                    description: "å½“å±€æ‰“æ‰‹å¿…é¡»è¯´å®Œè¯åè¾¹åŠ ä¸Š\"å–µ\""
                },
                {
                    id: 5,
                    name: "åƒæˆ‘ä¸€æŠ€",
                    icon: "âš”ï¸",
                    description: "è¯¥å±€æ‰“æ‰‹é‡Šæ”¾è‹±é›„æŠ€èƒ½å¿…é¡»å–Šå‡ºæ¥æŠ€èƒ½åå­—"
                },
                {
                    id: 6,
                    name: "ç”œèœœèœœ",
                    icon: "â¤ï¸",
                    description: "åŒæ‰“æ‰‹å½“å±€éœ€è¦äº’ç›¸ç”œèœœè¿›è¡Œæ¸¸æˆ"
                },
                {
                    id: 7,
                    name: "coså°é¬¼",
                    icon: "ğŸ­",
                    description: "åŒæ‰“æ‰‹å„è‡ªæ‰®æ¼”å°é¬¼ï¼Œä¾‹å¦‚å¯çˆ±é¬¼ã€èƒ†å°é¬¼è¿™ç§ï¼Œæ¸¸æˆå¯¹å±€ä¸­ï¼Œäº’ç›¸ç§°å‘¼å˜æˆæ‰®æ¼”çš„å°é¬¼åç§°"
                },
                {
                    id: 8,
                    name: "æˆ‘ä¼šè¯´æ–¹è¨€",
                    icon: "ğŸ—£ï¸",
                    description: "åŒæ‰“æ‰‹å½“å±€æ¸¸æˆå¿…é¡»ç”¨æ–¹è¨€æ²Ÿé€š"
                },
                {
                    id: 9,
                    name: "ç»æ´»å°é¬¼",
                    icon: "ğŸ¯",
                    description: "è€æ¿æŒ‡å®šä¸€æ®µè¯10-15å­—ï¼ŒåŒæ‰“æ‰‹å¿…é¡»å«æ°´è¯»å‡ºæ¥"
                }
            ]
        };
        
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            position: 1, // ç©å®¶å½“å‰ä½ç½®
            gameActive: false, // æ¸¸æˆæ˜¯å¦è¿›è¡Œä¸­
            placedItems: {}, // å·²æ”¾ç½®çš„é“å…· {ä½ç½®: é“å…·ä¿¡æ¯}
            selectedItem: null, // å½“å‰é€‰ä¸­çš„é“å…·
            bonusTurn: false, // æ˜¯å¦æœ‰é¢å¤–å›åˆ
            currentMode: "normal", // å½“å‰æ¨¡å¼ï¼Œé»˜è®¤æ™®é€šç‰ˆ
            isSpectator: false, // æ˜¯å¦ä¸ºè§‚ä¼—æ¨¡å¼
            gameId: generateGameId(), // æ¸¸æˆå”¯ä¸€IDï¼Œç”¨äºåˆ†äº«
            lastSyncTime: 0 // æœ€ååŒæ­¥æ—¶é—´
        };
        
        // DOMå…ƒç´  - åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨
        const syncStatus = document.getElementById('sync-status');
        
        // DOMå…ƒç´  - è§‚ä¼—/ç©å®¶æ¨¡å¼ç›¸å…³
        const playAsPlayerBtn = document.getElementById('play-as-player');
        const playAsSpectatorBtn = document.getElementById('play-as-spectator');
        const spectatorBadge = document.getElementById('spectator-badge');
        const shareSection = document.getElementById('share-section');
        const gameShareLink = document.getElementById('game-share-link');
        const copyShareLinkBtn = document.getElementById('copy-share-link');
        
        // DOMå…ƒç´  - é€šç”¨
        const winnerModal = document.getElementById('winner-modal');
        const winnerText = document.getElementById('winner-text');
        const playAgainBtn = document.getElementById('play-again');
        const closeWinnerBtn = document.getElementById('close-winner');
        const itemsModal = document.getElementById('items-modal');
        const closeItemsBtn = document.getElementById('close-items');
        const closeItemsBtn2 = document.getElementById('close-items-btn');
        const itemTriggerModal = document.getElementById('item-trigger-modal');
        const itemTriggerName = document.getElementById('item-trigger-name');
        const itemTriggerDesc = document.getElementById('item-trigger-desc');
        const continueButton = document.getElementById('continue-button');
        const stageInstruction = document.getElementById('stage-instruction');
        
        // DOMå…ƒç´  - é˜¶æ®µå®¹å™¨
        const modeSelectionStage = document.getElementById('mode-selection-stage');
        const itemPlacementStage = document.getElementById('item-placement-stage');
        const gameStage = document.getElementById('game-stage');
        
        // DOMå…ƒç´  - æ¨¡å¼é€‰æ‹©é˜¶æ®µ
        const nextToItemsBtn = document.getElementById('next-to-items');
        const modeButtons = document.querySelectorAll('.mode-btn');
        
        // DOMå…ƒç´  - é“å…·æ”¾ç½®é˜¶æ®µ
        const gameBoardPrep = document.getElementById('game-board-prep');
        const itemSelectionGridPrep = document.getElementById('item-selection-grid-prep');
        const placedItemsCountPrep = document.getElementById('placed-items-count-prep');
        const clearAllItemsPrep = document.getElementById('clear-all-items-prep');
        const showItemsPrep = document.getElementById('show-items-prep');
        const nextToGameBtn = document.getElementById('next-to-game');
        const backToModeBtn = document.getElementById('back-to-mode');
        
        // DOMå…ƒç´  - æ¸¸æˆé˜¶æ®µ
        const gameBoard = document.getElementById('game-board');
        const moveButton = document.getElementById('move-button');
        const moveValue = document.getElementById('move-value');
        const currentPosition = document.getElementById('current-position');
        const gameStatus = document.getElementById('game-status');
        const resetGameBtn = document.getElementById('reset-game');
        const backToItemsBtn = document.getElementById('back-to-items');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        // ç”Ÿæˆæ¸¸æˆå”¯ä¸€IDï¼ˆç¡®ä¿è·¨è®¾å¤‡å”¯ä¸€æ€§ï¼‰
        function generateGameId() {
            // ç»“åˆæ—¶é—´æˆ³å’Œéšæœºæ•°ç”Ÿæˆå”¯ä¸€ID
            return 'hg_' + Date.now().toString(36) + '_' + 
                   Math.random().toString(36).substring(2, 8);
        }
        
        // åˆ›å»ºåˆ†äº«é“¾æ¥ï¼ˆé€‚é…GitHub Pagesï¼‰
        function createShareLink() {
            // è·å–å½“å‰é¡µé¢URLï¼ˆè‡ªåŠ¨é€‚é…GitHub Pagesè·¯å¾„ï¼‰
            const baseUrl = window.location.href.split('?')[0];
            return `${baseUrl}?gameId=${gameState.gameId}&spectator=true`;
        }
        
        // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
        function updateSyncStatus(status) {
            syncStatus.className = 'sync-status';
            
            if (status === 'connected') {
                syncStatus.classList.add('connected');
                syncStatus.innerHTML = '<i class="fa fa-check mr-1"></i> åŒæ­¥ä¸­';
            } else if (status === 'disconnected') {
                syncStatus.classList.add('disconnected');
                syncStatus.innerHTML = '<i class="fa fa-exclamation-triangle mr-1"></i> åŒæ­¥ä¸­æ–­';
            } else {
                syncStatus.innerHTML = '<i class="fa fa-circle-o-notch fa-spin mr-1"></i> ç­‰å¾…åŒæ­¥...';
            }
        }
        
        // åˆ‡æ¢åˆ°ç©å®¶æ¨¡å¼
        function switchToPlayerMode() {
            gameState.isSpectator = false;
            document.body.classList.remove('spectator-mode');
            spectatorBadge.classList.add('hidden');
            shareSection.classList.remove('hidden'); // ç©å®¶å¯ä»¥çœ‹åˆ°åˆ†äº«é“¾æ¥
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            playAsPlayerBtn.classList.remove('bg-white/20', 'hover:bg-white/30', 'text-white');
            playAsPlayerBtn.classList.add('bg-white/30', 'hover:bg-white/40', 'text-white');
            playAsSpectatorBtn.classList.remove('bg-spectator/30', 'hover:bg-spectator/40', 'text-spectator');
            playAsSpectatorBtn.classList.add('bg-spectator/20', 'hover:bg-spectator/30', 'text-spectator');
            
            // æ›´æ–°åˆ†äº«é“¾æ¥
            gameShareLink.value = createShareLink();
            
            // æ›´æ–°åŒæ­¥çŠ¶æ€
            updateSyncStatus('connected');
            
            // ä¿å­˜æ¸¸æˆçŠ¶æ€ï¼ˆç©å®¶æ¨¡å¼æ¿€æ´»ï¼‰
            saveGameState();
        }
        
        // åˆ‡æ¢åˆ°è§‚ä¼—æ¨¡å¼
        function switchToSpectatorMode() {
            gameState.isSpectator = true;
            document.body.classList.add('spectator-mode');
            spectatorBadge.classList.remove('hidden');
            
            // è§‚ä¼—çœ‹ä¸åˆ°åˆ†äº«é“¾æ¥ï¼ˆåªæœ‰ç©å®¶èƒ½çœ‹åˆ°ï¼‰
            shareSection.classList.add('hidden');
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            playAsPlayerBtn.classList.remove('bg-white/30', 'hover:bg-white/40', 'text-white');
            playAsPlayerBtn.classList.add('bg-white/20', 'hover:bg-white/30', 'text-white');
            playAsSpectatorBtn.classList.remove('bg-spectator/20', 'hover:bg-spectator/30', 'text-spectator');
            playAsSpectatorBtn.classList.add('bg-spectator/30', 'hover:bg-spectator/40', 'text-spectator');
            
            // æ›´æ–°æç¤ºä¿¡æ¯
            if (gameState.gameActive) {
                stageInstruction.textContent = "è§‚ä¼—æ¨¡å¼ï¼šä½ å¯ä»¥è§‚çœ‹æ¸¸æˆï¼Œä½†ä¸èƒ½è¿›è¡Œæ“ä½œ";
            } else {
                stageInstruction.textContent = "è§‚ä¼—æ¨¡å¼ï¼šç­‰å¾…ç©å®¶å¼€å§‹æ¸¸æˆ...";
            }
            
            // ç«‹å³å°è¯•åŒæ­¥
            loadGameState();
        }
        
        // å¤åˆ¶åˆ†äº«é“¾æ¥
        function copyShareLink() {
            gameShareLink.select();
            document.execCommand('copy');
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
            const originalText = copyShareLinkBtn.innerHTML;
            copyShareLinkBtn.innerHTML = '<i class="fa fa-check"></i>';
            setTimeout(() => {
                copyShareLinkBtn.innerHTML = originalText;
            }, 2000);
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // æ£€æŸ¥URLå‚æ•°ï¼Œè‡ªåŠ¨è¿›å…¥è§‚ä¼—æ¨¡å¼
            const params = new URLSearchParams(window.location.search);
            if (params.get('spectator') === 'true') {
                // ä½¿ç”¨URLä¸­çš„æ¸¸æˆID
                gameState.gameId = params.get('gameId') || generateGameId();
                switchToSpectatorMode();
            } else {
                // å°è¯•ä»æœ¬åœ°å­˜å‚¨æ¢å¤æ¸¸æˆï¼ˆå¦‚æœæœ‰ï¼‰
                const savedState = localStorage.getItem(`halloween_game_${gameState.gameId}`);
                if (savedState) {
                    try {
                        const parsed = JSON.parse(savedState);
                        gameState = { ...gameState, ...parsed };
                    } catch (e) {
                        console.log('æ— æ³•æ¢å¤æ¸¸æˆçŠ¶æ€ï¼Œå°†åˆ›å»ºæ–°æ¸¸æˆ');
                    }
                }
                switchToPlayerMode(); // é»˜è®¤ç©å®¶æ¨¡å¼
            }
            
            // åˆå§‹åŒ–æ¨¡å¼é€‰æ‹©é˜¶æ®µ
            initModeSelectionStage();
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            addEventListeners();
            
            // åˆå§‹åŒ–åˆ†äº«é“¾æ¥
            gameShareLink.value = createShareLink();
        }
        
        // åˆå§‹åŒ–æ¨¡å¼é€‰æ‹©é˜¶æ®µ
        function initModeSelectionStage() {
            // è®¾ç½®é˜¶æ®µæç¤º
            if (gameState.isSpectator) {
                stageInstruction.textContent = "è§‚ä¼—æ¨¡å¼ï¼šç­‰å¾…ç©å®¶é€‰æ‹©æ¸¸æˆéš¾åº¦...";
            } else {
                stageInstruction.textContent = "é€‰æ‹©æ¸¸æˆéš¾åº¦ï¼Œå¼€å§‹ä½ çš„ä¸‡åœ£èŠ‚è¶£å‘³ä¹‹æ—…ï¼";
            }
        }
        
        // åˆå§‹åŒ–é“å…·æ”¾ç½®é˜¶æ®µ
        function initItemPlacementStage() {
            // è®¾ç½®é˜¶æ®µæç¤º
            if (gameState.isSpectator) {
                stageInstruction.textContent = "è§‚ä¼—æ¨¡å¼ï¼šè§‚çœ‹ç©å®¶é…ç½®é“å…·...";
            } else {
                stageInstruction.textContent = "é€‰æ‹©é“å…·å¹¶æ”¾ç½®åˆ°æ£‹ç›˜ä¸Šï¼Œå®Œæˆåè¿›å…¥æ¸¸æˆ";
            }
            
            // åˆ›å»ºæ£‹ç›˜
            createBoard(gameBoardPrep);
            
            // ç”Ÿæˆé“å…·é€‰æ‹©å¡ç‰‡
            createItemSelectionCards(itemSelectionGridPrep);
            
            // æ›´æ–°å·²æ”¾ç½®é“å…·è®¡æ•°
            updatePlacedItemsCount();
        }
        
        // åˆå§‹åŒ–æ¸¸æˆé˜¶æ®µ
        function initGameStage() {
            // è®¾ç½®é˜¶æ®µæç¤º
            if (gameState.isSpectator) {
                stageInstruction.textContent = "è§‚ä¼—æ¨¡å¼ï¼šè§‚çœ‹æ¸¸æˆè¿›è¡Œ...";
            } else {
                stageInstruction.textContent = "ç‚¹å‡»å‰è¿›æŒ‰é’®ç§»åŠ¨ï¼Œè§¦å‘æ ¼å­ä¸Šçš„é“å…·æ•ˆæœ";
            }
            
            // åˆ›å»ºæ¸¸æˆé˜¶æ®µçš„æ£‹ç›˜ï¼ˆä¸æ˜¾ç¤ºé“å…·æ ‡è®°ï¼‰
            createBoard(gameBoard, true);
            
            // åˆå§‹åŒ–ç©å®¶ä½ç½®
            updatePlayerPosition();
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
            updateGameStatus();
            
            // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
            updateProgressIndicator();
        }
        
        // åˆ‡æ¢é˜¶æ®µ
        function switchStage(stageName) {
            // éšè—æ‰€æœ‰é˜¶æ®µ
            modeSelectionStage.classList.remove('active');
            itemPlacementStage.classList.remove('active');
            gameStage.classList.remove('active');
            
            // æ˜¾ç¤ºç›®æ ‡é˜¶æ®µ
            if (stageName === 'mode-selection') {
                modeSelectionStage.classList.add('active');
                initModeSelectionStage();
            } else if (stageName === 'item-placement') {
                itemPlacementStage.classList.add('active');
                initItemPlacementStage();
            } else if (stageName === 'game') {
                stageInstruction.textContent = gameState.isSpectator ? 
                    "è§‚ä¼—æ¨¡å¼ï¼šè§‚çœ‹æ¸¸æˆè¿›è¡Œ..." : 
                    "ç‚¹å‡»å‰è¿›æŒ‰é’®ç§»åŠ¨ï¼Œè§¦å‘æ ¼å­é“å…·æ•ˆæœ";
                gameStage.classList.add('active');
                initGameStage();
            }
            
            // åŒæ­¥æ¸¸æˆçŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
            saveGameState();
        }
        
        // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°localStorageï¼ˆå¢å¼ºç‰ˆï¼‰
        function saveGameState() {
            try {
                // å­˜å‚¨å®Œæ•´çš„æ¸¸æˆçŠ¶æ€ï¼ŒåŒ…å«æ—¶é—´æˆ³ç”¨äºåŒæ­¥åˆ¤æ–­
                const stateToSave = {
                    ...gameState,
                    timestamp: new Date().getTime()
                };
                localStorage.setItem(`halloween_game_${gameState.gameId}`, JSON.stringify(stateToSave));
                
                // æ›´æ–°æœ€ååŒæ­¥æ—¶é—´
                gameState.lastSyncTime = stateToSave.timestamp;
                
                // å¦‚æœæ˜¯ç©å®¶ï¼Œæ›´æ–°åŒæ­¥çŠ¶æ€
                if (!gameState.isSpectator) {
                    updateSyncStatus('connected');
                }
            } catch (e) {
                console.error('ä¿å­˜æ¸¸æˆçŠ¶æ€å¤±è´¥:', e);
                if (!gameState.isSpectator) {
                    updateSyncStatus('disconnected');
                }
            }
        }
        
        // è·å–å½“å‰é˜¶æ®µ
        function getCurrentStage() {
            if (modeSelectionStage.classList.contains('active')) return 'mode-selection';
            if (itemPlacementStage.classList.contains('active')) return 'item-placement';
            if (gameStage.classList.contains('active')) return 'game';
            return 'mode-selection';
        }
        
        // åŠ è½½æ¸¸æˆçŠ¶æ€ï¼ˆè§‚ä¼—æ¨¡å¼ç”¨ï¼Œå¢å¼ºç‰ˆï¼‰
        function loadGameState() {
            if (!gameState.isSpectator) return;
            
            try {
                const savedState = localStorage.getItem(`halloween_game_${gameState.gameId}`);
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    const now = new Date().getTime();
                    
                    // åªåŒæ­¥3åˆ†é’Ÿå†…çš„çŠ¶æ€ï¼ˆé¿å…è¯»å–è¿‡æœŸæ•°æ®ï¼‰
                    if (now - parsedState.timestamp < 3 * 60 * 1000) {
                        // åªæœ‰å½“çŠ¶æ€æœ‰æ›´æ–°æ—¶æ‰åŒæ­¥
                        if (parsedState.timestamp > gameState.lastSyncTime) {
                            // ä¿å­˜å½“å‰é˜¶æ®µ
                            const currentStage = getCurrentStage();
                            
                            // æ›´æ–°æ¸¸æˆçŠ¶æ€
                            gameState = { ...gameState, ...parsedState, isSpectator: true };
                            
                            // æ›´æ–°æœ€ååŒæ­¥æ—¶é—´
                            gameState.lastSyncTime = parsedState.timestamp;
                            
                            // å¦‚æœé˜¶æ®µä¸åŒï¼Œåˆ‡æ¢é˜¶æ®µ
                            if (currentStage !== parsedState.currentStage) {
                                switchStage(parsedState.currentStage);
                            } else {
                                // æ›´æ–°å½“å‰é˜¶æ®µçš„UI
                                if (currentStage === 'game') {
                                    updatePlayerPosition();
                                    updateGameStatus();
                                    updateProgressIndicator();
                                } else if (currentStage === 'item-placement') {
                                    createBoard(gameBoardPrep);
                                    updatePlacedItemsCount();
                                }
                            }
                            
                            updateSyncStatus('connected');
                            return;
                        }
                    } else {
                        // çŠ¶æ€è¿‡æœŸ
                        updateSyncStatus('disconnected');
                        stageInstruction.textContent = "è§‚ä¼—æ¨¡å¼ï¼šæ¸¸æˆè¿æ¥å·²è¿‡æœŸï¼Œè¯·è·å–æ–°çš„åˆ†äº«é“¾æ¥";
                    }
                } else {
                    // æœªæ‰¾åˆ°æ¸¸æˆçŠ¶æ€
                    updateSyncStatus('disconnected');
                    stageInstruction.textContent = "è§‚ä¼—æ¨¡å¼ï¼šæœªæ‰¾åˆ°æ¸¸æˆï¼Œè¯·ç¡®è®¤åˆ†äº«é“¾æ¥æ­£ç¡®";
                }
            } catch (e) {
                console.error('åŠ è½½æ¸¸æˆçŠ¶æ€å¤±è´¥:', e);
                updateSyncStatus('disconnected');
            }
        }
        
        // åˆ›å»ºæ£‹ç›˜
        function createBoard(boardElement, isGameStage = false) {
            boardElement.innerHTML = '';
            
            for (let i = 1; i <= GAME_CONFIG.totalSquares; i++) {
                const square = document.createElement('div');
                square.classList.add('square');
                square.dataset.number = i;
                square.innerHTML = `<span class="text-white text-shadow">${i}</span>`;
                
                // å¦‚æœæ˜¯å‡†å¤‡é˜¶æ®µï¼Œæ·»åŠ æ ¼å­ç‚¹å‡»äº‹ä»¶ï¼ˆæ”¾ç½®é“å…·ï¼‰å¹¶æ˜¾ç¤ºå·²æ”¾ç½®çš„é“å…·
                if (!isGameStage) {
                    square.addEventListener('click', () => placeItemOnSquare(i));
                    
                    // å‡†å¤‡é˜¶æ®µæ˜¾ç¤ºé“å…·
                    if (gameState.placedItems[i]) {
                        square.innerHTML += `
                            <div class="item-marker">${gameState.placedItems[i].icon}</div>
                            <div class="item-tooltip">${gameState.placedItems[i].name}</div>
                        `;
                    }
                } 
                // æ¸¸æˆé˜¶æ®µä¸æ˜¾ç¤ºé“å…·æ ‡è®°ï¼Œä¿æŒæ ¼å­å¹²å‡€
                else {
                    // ä¸æ·»åŠ ä»»ä½•é“å…·æ ‡è®°
                }
                
                boardElement.appendChild(square);
            }
        }
        
        // ç”Ÿæˆé“å…·é€‰æ‹©å¡ç‰‡
        function createItemSelectionCards(container) {
            container.innerHTML = '';
            
            GAME_CONFIG.items.forEach(item => {
                const card = document.createElement('div');
                card.classList.add('item-card', 'bg-white/80', 'rounded-lg', 'p-3', 'backdrop-blur-sm', 'interactive-element');
                card.innerHTML = `
                    <div class="flex flex-col items-center">
                        <span class="text-xl mb-2">${item.icon}</span>
                        <span class="font-medium text-center">${item.name}</span>
                    </div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                card.addEventListener('click', () => selectItem(item));
                
                container.appendChild(card);
            });
        }
        
        // é€‰æ‹©é“å…·
        function selectItem(item) {
            // å¦‚æœå·²ç»è¿›å…¥æ¸¸æˆæˆ–å¤„äºè§‚ä¼—æ¨¡å¼ï¼Œä¸èƒ½é€‰æ‹©é“å…·
            if (gameState.gameActive || gameState.isSpectator) return;
            
            // ç§»é™¤å…¶ä»–å¡ç‰‡çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('item-active');
            });
            
            // æ·»åŠ å½“å‰å¡ç‰‡çš„æ¿€æ´»çŠ¶æ€
            const cards = itemSelectionGridPrep.querySelectorAll('.item-card');
            cards[item.id - 1].classList.add('item-active');
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            gameState.selectedItem = item;
        }
        
        // åœ¨æ ¼å­ä¸Šæ”¾ç½®é“å…·
        function placeItemOnSquare(position) {
            // å¦‚æœæ˜¯è§‚ä¼—æ¨¡å¼ï¼Œä¸èƒ½æ”¾ç½®é“å…·
            if (gameState.isSpectator) return;
            
            const currentMaxItems = GAME_CONFIG.modes[gameState.currentMode].maxItems;
            const currentCount = Object.keys(gameState.placedItems).length;
            
            // æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°å½“å‰æ¨¡å¼çš„æœ€å¤§é“å…·æ•°é‡
            if (currentCount >= currentMaxItems && !gameState.placedItems[position]) {
                return;
            }
            
            // å¦‚æœæ²¡æœ‰é€‰ä¸­é“å…·ï¼Œä¸æ‰§è¡Œæ“ä½œ
            if (!gameState.selectedItem) {
                return;
            }
            
            // å¦‚æœè¯¥ä½ç½®å·²æœ‰é“å…·ï¼Œæ›¿æ¢å®ƒ
            if (gameState.placedItems[position]) {
                // ç§»é™¤åŸæœ‰é“å…·æ ‡è®°
                const square = gameBoardPrep.querySelector(`.square[data-number="${position}"]`);
                const existingMarker = square.querySelector('.item-marker');
                const existingTooltip = square.querySelector('.item-tooltip');
                if (existingMarker) existingMarker.remove();
                if (existingTooltip) existingTooltip.remove();
            }
            
            // æ”¾ç½®æ–°é“å…·
            gameState.placedItems[position] = gameState.selectedItem;
            
            // åœ¨æ ¼å­ä¸Šæ˜¾ç¤ºé“å…·æ ‡è®°ï¼ˆä»…åœ¨å‡†å¤‡é˜¶æ®µï¼‰
            const square = gameBoardPrep.querySelector(`.square[data-number="${position}"]`);
            square.innerHTML += `
                <div class="item-marker">${gameState.selectedItem.icon}</div>
                <div class="item-tooltip">${gameState.selectedItem.name}</div>
            `;
            
            // æ›´æ–°å·²æ”¾ç½®é“å…·è®¡æ•°
            updatePlacedItemsCount();
            
            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('item-active');
            });
            gameState.selectedItem = null;
            
            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameState();
        }
        
        // æ›´æ–°å·²æ”¾ç½®é“å…·è®¡æ•°
        function updatePlacedItemsCount() {
            const count = Object.keys(gameState.placedItems).length;
            const maxItems = GAME_CONFIG.modes[gameState.currentMode].maxItems;
            const modeName = GAME_CONFIG.modes[gameState.currentMode].name;
            placedItemsCountPrep.textContent = `å·²æ”¾ç½®é“å…·ï¼š${count}/${maxItems}ï¼ˆ${modeName}æœ€å¤šæ”¾ç½®${maxItems}ä¸ªï¼‰`;
        }
        
        // åˆ‡æ¢æ¸¸æˆæ¨¡å¼
        function switchMode(mode) {
            // å¦‚æœå·²ç»æ˜¯å½“å‰æ¨¡å¼æˆ–å¤„äºè§‚ä¼—æ¨¡å¼ï¼Œä¸åšå¤„ç†
            if (gameState.currentMode === mode || gameState.isSpectator) return;
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            gameState.currentMode = mode;
            
            // æ›´æ–°UI
            modeButtons.forEach((btn, index) => {
                if ((mode === 'normal' && index === 0) || (mode === 'hard' && index === 1)) {
                    btn.classList.add('mode-active');
                    btn.querySelector('h4').classList.add('text-accent');
                    btn.querySelector('h4').classList.remove('text-white');
                } else {
                    btn.classList.remove('mode-active');
                    btn.querySelector('h4').classList.remove('text-accent');
                    btn.querySelector('h4').classList.add('text-white');
                }
            });
            
            // å¦‚æœå·²æ”¾ç½®çš„é“å…·è¶…è¿‡æ–°æ¨¡å¼çš„é™åˆ¶ï¼Œæ¸…é™¤è¶…å‡ºéƒ¨åˆ†
            const maxItems = GAME_CONFIG.modes[mode].maxItems;
            const currentItems = Object.keys(gameState.placedItems);
            
            if (currentItems.length > maxItems) {
                // åªä¿ç•™å‰maxItemsä¸ªé“å…·
                const itemsToRemove = currentItems.slice(maxItems);
                itemsToRemove.forEach(position => {
                    delete gameState.placedItems[position];
                    
                    // ç§»é™¤æ ¼å­ä¸Šçš„é“å…·æ ‡è®°
                    const square = gameBoardPrep.querySelector(`.square[data-number="${position}"]`);
                    const marker = square.querySelector('.item-marker');
                    const tooltip = square.querySelector('.item-tooltip');
                    if (marker) marker.remove();
                    if (tooltip) tooltip.remove();
                });
            }
            
            // æ›´æ–°è®¡æ•°å’ŒUI
            updatePlacedItemsCount();
            clearSelection();
            
            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameState();
        }
        
        // æ¸…é™¤é“å…·é€‰æ‹©çŠ¶æ€
        function clearSelection() {
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('item-active');
            });
            gameState.selectedItem = null;
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            // å¦‚æœæ˜¯è§‚ä¼—æ¨¡å¼ï¼Œä¸èƒ½å¼€å§‹æ¸¸æˆ
            if (gameState.isSpectator) return;
            
            gameState.gameActive = true;
            switchStage('game');
        }
        
        // è¿”å›é“å…·æ”¾ç½®é˜¶æ®µ
        function returnToItemPlacement() {
            // å¦‚æœæ˜¯è§‚ä¼—æ¨¡å¼ï¼Œä¸èƒ½è¿”å›
            if (gameState.isSpectator) return;
            
            gameState.gameActive = false;
            gameState.position = 1;
            gameState.bonusTurn = false;
            switchStage('item-placement');
        }
        
        // è¿”å›æ¨¡å¼é€‰æ‹©é˜¶æ®µ
        function returnToModeSelection() {
            // å¦‚æœæ˜¯è§‚ä¼—æ¨¡å¼ï¼Œä¸èƒ½è¿”å›
            if (gameState.isSpectator) return;
            
            gameState.gameActive = false;
            gameState.position = 1;
            gameState.bonusTurn = false;
            switchStage('mode-selection');
        }
        
        // æ›´æ–°ç©å®¶ä½ç½®
        function updatePlayerPosition() {
            // ç§»é™¤æ‰€æœ‰ç©å®¶æ ‡è®°
            document.querySelectorAll('.player').forEach(player => player.remove());
            
            // ç§»é™¤æ‰€æœ‰æ ¼å­çš„é«˜äº®çŠ¶æ€
            document.querySelectorAll('.square').forEach(square => {
                square.classList.remove('current');
            });
            
            // æ›´æ–°ç©å®¶ä½ç½®
            const square = gameBoard.querySelector(`.square[data-number="${gameState.position}"]`);
            
            if (square) {
                // é«˜äº®æ˜¾ç¤ºå½“å‰æ ¼å­
                square.classList.add('current');
                
                // æ·»åŠ ç©å®¶æ ‡è®°
                const player = document.createElement('div');
                player.classList.add('player', 'player-1');
                square.appendChild(player);
            }
            
            // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
            updateProgressIndicator();
            
            // æ›´æ–°å½“å‰ä½ç½®æ–‡æœ¬
            currentPosition.textContent = `ç¬¬ ${gameState.position} æ ¼`;
            
            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameState();
        }
        
        // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
        function updateProgressIndicator() {
            const progress = (gameState.position / GAME_CONFIG.totalSquares) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${gameState.position}/${GAME_CONFIG.totalSquares}`;
        }
        
        // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
        function updateGameStatus() {
            if (gameState.bonusTurn) {
                gameStatus.textContent = 'è·å¾—é¢å¤–ä¸€æ¬¡å‰è¿›æœºä¼šï¼';
                gameStatus.classList.add('text-accent');
            } else {
                gameStatus.textContent = 'æ¸¸æˆè¿›è¡Œä¸­';
                gameStatus.classList.remove('text-accent');
            }
        }
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        function addEventListeners() {
            // è§‚ä¼—/ç©å®¶æ¨¡å¼åˆ‡æ¢
            playAsPlayerBtn.addEventListener('click', switchToPlayerMode);
            playAsSpectatorBtn.addEventListener('click', switchToSpectatorMode);
            
            // å¤åˆ¶åˆ†äº«é“¾æ¥
            copyShareLinkBtn.addEventListener('click', copyShareLink);
            
            // é˜¶æ®µåˆ‡æ¢æŒ‰é’®
            nextToItemsBtn.addEventListener('click', () => {
                if (!gameState.isSpectator) {
                    switchStage('item-placement');
                }
            });
            nextToGameBtn.addEventListener('click', startGame);
            backToModeBtn.addEventListener('click', returnToModeSelection);
            backToItemsBtn.addEventListener('click', returnToItemPlacement);
            resetGameBtn.addEventListener('click', returnToModeSelection);
            playAgainBtn.addEventListener('click', () => {
                winnerModal.classList.add('hidden');
                // é‡ç½®æ¸¸æˆIDï¼Œå¼€å§‹æ–°æ¸¸æˆ
                gameState.gameId = generateGameId();
                gameShareLink.value = createShareLink();
                returnToModeSelection();
            });
            
            // å‰è¿›æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            moveButton.addEventListener('click', moveForward);
            
            // é“å…·æ¨¡æ€æ¡†
            showItemsPrep.addEventListener('click', () => {
                itemsModal.classList.remove('hidden');
            });
            
            closeItemsBtn.addEventListener('click', () => {
                itemsModal.classList.add('hidden');
            });
            
            closeItemsBtn2.addEventListener('click', () => {
                itemsModal.classList.add('hidden');
            });
            
            // æ¸…é™¤æ‰€æœ‰é“å…·ï¼ˆé“å…·æ”¾ç½®é˜¶æ®µï¼‰
            clearAllItemsPrep.addEventListener('click', clearAllItems);
            
            // é“å…·è§¦å‘æç¤ºæ¡†
            continueButton.addEventListener('click', () => {
                itemTriggerModal.classList.add('hidden');
                // ç»§ç»­å‰è¿›ï¼ˆé¢å¤–å›åˆï¼‰
                moveForward();
            });
            
            // èƒœåˆ©æ¨¡æ€æ¡†
            closeWinnerBtn.addEventListener('click', () => {
                winnerModal.classList.add('hidden');
            });
            
            // æ¨¡å¼é€‰æ‹©äº‹ä»¶
            modeButtons[0].addEventListener('click', () => switchMode('normal'));
            modeButtons[1].addEventListener('click', () => switchMode('hard'));
            
            // ç›‘å¬æœ¬åœ°å­˜å‚¨å˜åŒ–ï¼Œå®ç°æ›´å®æ—¶çš„åŒæ­¥ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰
            window.addEventListener('storage', (e) => {
                if (e.key === `halloween_game_${gameState.gameId}` && gameState.isSpectator) {
                    loadGameState(); // å½“å­˜å‚¨å˜åŒ–æ—¶ç«‹å³åŒæ­¥
                }
            });
            
            // è§‚ä¼—æ¨¡å¼ä¸‹å®šæœŸåŒæ­¥ï¼ˆåŒé‡ä¿éšœï¼‰
            if (gameState.isSpectator) {
                setInterval(loadGameState, 500); // æ¯500msåŒæ­¥ä¸€æ¬¡
            }
        }
        
        // å‰è¿›
        function moveForward() {
            // å¦‚æœæ¸¸æˆæœªè¿›è¡Œæˆ–å¤„äºè§‚ä¼—æ¨¡å¼ï¼Œä¸æ‰§è¡Œå‰è¿›
            if (!gameState.gameActive || gameState.isSpectator) {
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®
            moveButton.disabled = true;
            moveButton.classList.add('opacity-70');
            
            // å›ºå®šå‰è¿›1æ ¼
            const steps = 1;
            moveValue.textContent = `å‰è¿› ${steps} æ ¼ï¼`;
            
            // æ˜¾ç¤ºå‰è¿›åŠ¨ç”»
            setTimeout(() => {
                // ç§»åŠ¨ç©å®¶
                let newPosition = gameState.position + steps;
                
                // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç»ˆç‚¹
                if (newPosition === GAME_CONFIG.totalSquares) {
                    // æ›´æ–°ç©å®¶ä½ç½®
                    gameState.position = newPosition;
                    updatePlayerPosition();
                    
                    // ç»“æŸæ¸¸æˆ
                    endGame();
                    return;
                }
                
                // å¦‚æœè¶…è¿‡ç»ˆç‚¹ï¼Œä¸èƒ½å‰è¿›
                if (newPosition > GAME_CONFIG.totalSquares) {
                    moveValue.textContent = `å½“å‰ä½ç½® ${gameState.position}ï¼Œéœ€è¦æ­£å¥½åˆ°è¾¾20æ ¼æ‰èƒ½è·èƒœï¼`;
                    moveButton.disabled = false;
                    moveButton.classList.remove('opacity-70');
                    return;
                }
                
                // æ›´æ–°ç©å®¶ä½ç½®
                gameState.position = newPosition;
                updatePlayerPosition();
                
                // æ£€æŸ¥æ˜¯å¦è§¦å‘é“å…·æ•ˆæœ
                checkItemEffect(newPosition);
                
                // å¦‚æœæ²¡æœ‰é¢å¤–å›åˆï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                if (!gameState.bonusTurn) {
                    setTimeout(() => {
                        moveValue.textContent = 'ç‚¹å‡»æŒ‰é’®ç»§ç»­å‰è¿›';
                        moveButton.disabled = false;
                        moveButton.classList.remove('opacity-70');
                    }, 500);
                }
                
                updateGameStatus();
            }, 800);
        }
        
        // æ£€æŸ¥é“å…·æ•ˆæœ - åªæœ‰èµ°åˆ°è¯¥æ ¼å­æ‰ä¼šæ˜¾ç¤ºæç¤º
        function checkItemEffect(position) {
            const item = gameState.placedItems[position];
            
            if (item) {
                // æ˜¾ç¤ºé“å…·è§¦å‘æç¤ºï¼ˆåªæœ‰èµ°åˆ°è¿™é‡Œæ‰ä¼šæç¤ºï¼‰
                itemTriggerName.textContent = item.name;
                itemTriggerDesc.textContent = item.description;
                itemTriggerModal.classList.remove('hidden');
                
                // æ ‡è®°ä¸ºå·²è§¦å‘ï¼ˆç§»é™¤é“å…·ï¼‰
                delete gameState.placedItems[position];
                
                // è®¾ç½®é¢å¤–å›åˆ
                gameState.bonusTurn = true;
            } else {
                // æ²¡æœ‰è§¦å‘é“å…·ï¼Œé‡ç½®é¢å¤–å›åˆçŠ¶æ€
                gameState.bonusTurn = false;
            }
            
            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameState();
        }
        
        // æ¸…é™¤æ‰€æœ‰é“å…·
        function clearAllItems() {
            // å¦‚æœæ˜¯è§‚ä¼—æ¨¡å¼ï¼Œä¸èƒ½æ¸…é™¤é“å…·
            if (gameState.isSpectator) return;
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€ä¸­çš„é“å…·
            gameState.placedItems = {};
            
            // ç§»é™¤æ‰€æœ‰æ ¼å­ä¸Šçš„é“å…·æ ‡è®°
            document.querySelectorAll('.item-marker').forEach(marker => marker.remove());
            document.querySelectorAll('.item-tooltip').forEach(tooltip => tooltip.remove());
            
            // æ›´æ–°è®¡æ•°
            updatePlacedItemsCount();
            
            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            clearSelection();
            
            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameState();
        }
        
        // ç»“æŸæ¸¸æˆ
        function endGame() {
            gameState.gameActive = false;
            gameStatus.textContent = 'æ­å–œä½ è·èƒœï¼';
            gameStatus.classList.add('text-accent');
            
            // æ˜¾ç¤ºèƒœåˆ©åŠ¨ç”»
            createConfetti();
            
            // æ˜¾ç¤ºèƒœåˆ©æ¨¡æ€æ¡†
            winnerText.textContent = 'æ­å–œä½ æ­£å¥½åˆ°è¾¾ç»ˆç‚¹ï¼Œè·å¾—èƒœåˆ©ï¼';
            winnerModal.classList.remove('hidden');
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            moveButton.disabled = false;
            moveButton.classList.remove('opacity-70');
            
            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameState();
        }
        
        // åˆ›å»ºåº†ç¥æ•ˆæœ
        function createConfetti() {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = `${Math.random() * 3}s`;
                
                document.body.appendChild(confetti);
                
                // ç§»é™¤åº†ç¥å…ƒç´ 
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>